<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯ä¸­å¿ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #667eea;
            font-size: 24px;
        }
        .btn-back {
            padding: 10px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }
        .main-container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .sidebar h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }
        .chat-item {
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chat-item:hover {
            background: #f0f0f0;
        }
        .chat-item.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .chat-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .chat-item-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-item-info {
            flex: 1;
            min-width: 0;
        }
        .chat-item-name {
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-item-preview {
            font-size: 12px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-create-group, .btn-add-friend {
            flex: 1;
            padding: 12px;
            background: linear-gradient(45deg, #43e97b, #38f9d7);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        .btn-add-friend {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }
        .chat-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h2 {
            color: #333;
            font-size: 20px;
        }
        .btn-share-game {
            padding: 8px 15px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            position: relative;
        }
        .message.self {
            align-self: flex-end;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 5px;
        }
        .message.other {
            align-self: flex-start;
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        .message.system {
            align-self: center;
            background: #fff3cd;
            color: #856404;
            font-size: 12px;
            border-radius: 20px;
            padding: 5px 15px;
        }
        .message.game-share {
            align-self: center;
            background: linear-gradient(45deg, #43e97b, #38f9d7);
            color: white;
            border-radius: 10px;
            padding: 15px 20px;
            max-width: 80%;
        }
        .message-sender {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        .message-time {
            font-size: 10px;
            margin-top: 5px;
            opacity: 0.6;
        }
        .message-input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
            height: 45px;
        }
        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn-send {
            padding: 12px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 400px;
            max-width: 90%;
        }
        .modal-content h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .btn-modal {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-confirm {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .btn-cancel {
            background: #f0f0f0;
            color: #666;
        }
        .game-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .game-option {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        .game-option:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ’¬ æ¶ˆæ¯ä¸­å¿ƒ</h1>
        <button class="btn-back" onclick="location.href='../index.html'">è¿”å›ä¸»é¡µ</button>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h3>ğŸ“‹ èŠå¤©åˆ—è¡¨</h3>
            <div class="chat-list" id="chatList">
                <div class="chat-item active" onclick="selectChat('global')">
                    <div class="chat-item-avatar">ğŸŒ</div>
                    <div class="chat-item-info">
                        <div class="chat-item-name">å…¨å±€æ¶ˆæ¯</div>
                        <div class="chat-item-preview">æ¬¢è¿æ¥åˆ°æ¸¸æˆä¸–ç•Œï¼</div>
                    </div>
                </div>
                <div class="chat-item" onclick="selectChat('developer')">
                    <div class="chat-item-avatar">ğŸ‘¨â€ğŸ’»</div>
                    <div class="chat-item-info">
                        <div class="chat-item-name">è”ç³»å¼€å‘è€…</div>
                        <div class="chat-item-preview">æœ‰é—®é¢˜éšæ—¶è”ç³»æˆ‘</div>
                    </div>
                </div>
            </div>
            <div class="sidebar-buttons">
                <button class="btn-add-friend" onclick="showAddFriend()">ğŸ‘¤ åŠ å¥½å‹</button>
                <button class="btn-create-group" onclick="showCreateGroup()">â• ç¾¤èŠ</button>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <h2 id="chatTitle">ğŸŒ å…¨å±€æ¶ˆæ¯</h2>
                <button class="btn-share-game" onclick="showShareGame()">ğŸ® åˆ†äº«æ¸¸æˆ</button>
            </div>
            <div class="messages" id="messages"></div>
            <div class="message-input-area">
                <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="btn-send" onclick="sendMessage()">å‘é€</button>
            </div>
        </div>
    </div>

    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <h3>ğŸ“ åˆ›å»ºç¾¤èŠ</h3>
            <input type="text" class="modal-input" id="groupName" placeholder="ç¾¤èŠåç§°">
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeModal('createGroupModal')">å–æ¶ˆ</button>
                <button class="btn-modal btn-confirm" onclick="createGroup()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <h3>ğŸ‘¤ æ·»åŠ å¥½å‹</h3>
            <input type="text" class="modal-input" id="friendUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeModal('addFriendModal')">å–æ¶ˆ</button>
                <button class="btn-modal btn-confirm" onclick="addFriend()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div class="modal" id="shareGameModal">
        <div class="modal-content">
            <h3>ğŸ® åˆ†äº«æ¸¸æˆ</h3>
            <p style="margin-bottom: 15px; color: #666;">é€‰æ‹©è¦åˆ†äº«çš„æ¸¸æˆï¼š</p>
            <div class="game-select" id="gameSelect"></div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn-modal btn-cancel" onclick="closeModal('shareGameModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
            alert('è¯·å…ˆç™»å½•ï¼');
            location.href = '../account/account.html';
        }

        const games = [
            { id: 1, name: 'ç‚¸æ¯æ•Œæœº', file: 'game/game1.html' },
            { id: 2, name: 'æˆ˜æœ¯æ’¤ç¦»', file: 'game/game2.html' },
            { id: 3, name: 'é˜µè¥å¯¹æŠ—', file: 'game/game3.html' },
            { id: 4, name: 'æ•°å­—æ‹†å¼¹ä¸“å®¶', file: 'game/game4.html' },
            { id: 5, name: 'ä¿„ç½—æ–¯æ–¹å—', file: 'game/game5.html' },
            { id: 6, name: 'ä½ ç”»æˆ‘çŒœ', file: 'game/game6.html' },
            { id: 7, name: 'è°æ˜¯å§åº•', file: 'game/game7.html' },
            { id: 8, name: 'ç¼–ç¨‹å¤§å¸ˆ', file: 'game/game8.html' },
            { id: 9, name: 'åƒç´ å¤§ä½œæˆ˜', file: 'game/game9.html' },
            { id: 10, name: 'å¤å¤æ‰“ç –å—', file: 'game/game10.html' },
            { id: 11, name: 'åŒæ¡Œæ¶ˆæ¶ˆä¹', file: 'game/game11.html' },
            { id: 12, name: 'è„‘æ´æ¼‚æµç“¶', file: 'game/game12.html' },
            { id: 13, name: 'è¡¨æƒ…è¿è¿çœ‹', file: 'game/game13.html' },
            { id: 14, name: 'ç­çº§å¤§å¯Œç¿', file: 'game/game14.html' },
            { id: 15, name: 'å€’æ”¾çŒœæ­Œ', file: 'game/game15.html' }
        ];

        let currentChat = 'global';
        let chats = {
            'global': {
                name: 'ğŸŒ å…¨å±€æ¶ˆæ¯',
                messages: [
                    { sender: 'ç³»ç»Ÿ', content: 'æ¬¢è¿æ¥åˆ°æ¸¸æˆä¸–ç•Œï¼', time: '12:00', type: 'system' },
                    { sender: 'ç³»ç»Ÿ', content: 'æ–°ç©å®¶æ³¨å†Œé€100é‡‘å¸ï¼', time: '12:01', type: 'system' }
                ]
            },
            'developer': {
                name: 'ğŸ‘¨â€ğŸ’» è”ç³»å¼€å‘è€…',
                messages: [
                    { sender: 'å¼€å‘è€…', content: 'æœ‰é—®é¢˜éšæ—¶è”ç³»æˆ‘', time: '10:00', type: 'other' }
                ]
            }
        };

        // åˆå§‹åŒ–æ¸¸æˆé€‰æ‹©
        function initGameSelect() {
            const container = document.getElementById('gameSelect');
            games.forEach(game => {
                const div = document.createElement('div');
                div.className = 'game-option';
                div.textContent = game.name;
                div.onclick = () => shareGame(game);
                container.appendChild(div);
            });
        }

        // é€‰æ‹©èŠå¤©
        function selectChat(chatId) {
            currentChat = chatId;
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            document.getElementById('chatTitle').textContent = chats[chatId].name;
            renderMessages();
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            chats[currentChat].messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'message ' + msg.type;
                
                if (msg.type === 'game-share') {
                    div.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 5px;">ğŸ® æ¸¸æˆåˆ†äº«</div>
                        <div>${msg.content}</div>
                        <div style="margin-top: 10px;">
                            <button onclick="location.href='${msg.gameUrl}'">ç«‹å³æ¸¸ç©</button>
                        </div>
                        <div class="message-time" style="margin-top: 10px;">${msg.time}</div>
                    `;
                } else if (msg.type !== 'system') {
                    div.innerHTML = `
                        <div class="message-sender">${msg.sender}</div>
                        <div>${msg.content}</div>
                        <div class="message-time">${msg.time}</div>
                    `;
                } else {
                    div.textContent = msg.content;
                }
                
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ':' + 
                         now.getMinutes().toString().padStart(2, '0');
            
            chats[currentChat].messages.push({
                sender: currentUser,
                content: content,
                time: time,
                type: 'self'
            });
            
            input.value = '';
            renderMessages();
            
            // æ¨¡æ‹Ÿå›å¤
            if (currentChat === 'developer') {
                setTimeout(() => {
                    chats[currentChat].messages.push({
                        sender: 'å¼€å‘è€…',
                        content: 'æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼Œæˆ‘ä¼šå°½å¿«å›å¤ï¼',
                        time: time,
                        type: 'other'
                    });
                    renderMessages();
                }, 1000);
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºç¾¤èŠ
        function showCreateGroup() {
            document.getElementById('createGroupModal').classList.add('active');
        }

        // æ˜¾ç¤ºæ·»åŠ å¥½å‹
        function showAddFriend() {
            document.getElementById('addFriendModal').classList.add('active');
        }

        // æ·»åŠ å¥½å‹
        function addFriend() {
            const friendUsername = document.getElementById('friendUsername').value.trim();
            
            if (!friendUsername) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            if (friendUsername === currentUser) {
                alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹');
                return;
            }
            
            // è·å–ç”¨æˆ·åˆ—è¡¨
            const users = JSON.parse(localStorage.getItem('gameUsers') || '{}');
            
            if (!users[friendUsername]) {
                alert('è¯¥ç”¨æˆ·ä¸å­˜åœ¨');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
            const currentUserData = users[currentUser];
            if (currentUserData.friends && currentUserData.friends.includes(friendUsername)) {
                alert('è¯¥ç”¨æˆ·å·²ç»æ˜¯ä½ çš„å¥½å‹');
                return;
            }
            
            // æ·»åŠ å¥½å‹
            if (!currentUserData.friends) {
                currentUserData.friends = [];
            }
            currentUserData.friends.push(friendUsername);
            
            // åŒæ—¶ä¹Ÿæ·»åŠ å¯¹æ–¹çš„å¥½å‹
            if (!users[friendUsername].friends) {
                users[friendUsername].friends = [];
            }
            users[friendUsername].friends.push(currentUser);
            
            // ä¿å­˜
            localStorage.setItem('gameUsers', JSON.stringify(users));
            
            // åˆ›å»ºç§èŠ
            const chatId = 'friend_' + friendUsername;
            chats[chatId] = {
                name: 'ğŸ’¬ ' + friendUsername,
                messages: [
                    { sender: 'ç³»ç»Ÿ', content: `${friendUsername} å·²æ·»åŠ ä¸ºå¥½å‹`, time: getCurrentTime(), type: 'system' }
                ]
            };
            
            // æ·»åŠ åˆ°èŠå¤©åˆ—è¡¨
            const chatList = document.getElementById('chatList');
            const item = document.createElement('div');
            item.className = 'chat-item';
            
            // è·å–å¥½å‹å¤´åƒ
            const friendAvatar = users[friendUsername].avatar;
            const avatarHtml = friendAvatar 
                ? `<img src="${friendAvatar}" alt="${friendUsername}">` 
                : 'ğŸ‘¤';
            
            item.innerHTML = `
                <div class="chat-item-avatar">${avatarHtml}</div>
                <div class="chat-item-info">
                    <div class="chat-item-name">${friendUsername}</div>
                    <div class="chat-item-preview">å¥½å‹ - å¯ä»¥åˆ†äº«æ¸¸æˆ</div>
                </div>
            `;
            item.onclick = function() { selectChat(chatId); };
            chatList.appendChild(item);
            
            closeModal('addFriendModal');
            document.getElementById('friendUsername').value = '';
            alert('æ·»åŠ å¥½å‹æˆåŠŸï¼');
        }

        // åˆ›å»ºç¾¤èŠ
        function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
                return;
            }
            
            const chatId = 'group_' + Date.now();
            chats[chatId] = {
                name: 'ğŸ‘¥ ' + name,
                messages: [
                    { sender: 'ç³»ç»Ÿ', content: `${currentUser} åˆ›å»ºäº†ç¾¤èŠ`, time: getCurrentTime(), type: 'system' }
                ]
            };
            
            // æ·»åŠ åˆ°èŠå¤©åˆ—è¡¨
            const chatList = document.getElementById('chatList');
            const item = document.createElement('div');
            item.className = 'chat-item';
            item.innerHTML = `
                <div class="chat-item-avatar">ğŸ‘¥</div>
                <div class="chat-item-info">
                    <div class="chat-item-name">${name}</div>
                    <div class="chat-item-preview">ç¾¤èŠ - å¯ä»¥åˆ†äº«æ¸¸æˆ</div>
                </div>
            `;
            item.onclick = function() { selectChat(chatId); };
            chatList.appendChild(item);
            
            closeModal('createGroupModal');
            document.getElementById('groupName').value = '';
        }

        // æ˜¾ç¤ºåˆ†äº«æ¸¸æˆ
        function showShareGame() {
            document.getElementById('shareGameModal').classList.add('active');
        }

        // åˆ†äº«æ¸¸æˆ
        function shareGame(game) {
            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ':' + 
                         now.getMinutes().toString().padStart(2, '0');
            
            chats[currentChat].messages.push({
                sender: currentUser,
                content: `æˆ‘æ¨èä½ ç©ã€Š${game.name}ã€‹ï¼`,
                time: time,
                type: 'game-share',
                gameUrl: '../' + game.file
            });
            
            closeModal('shareGameModal');
            renderMessages();
        }

        // å…³é—­å¼¹çª—
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // è·å–å½“å‰æ—¶é—´
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        initGameSelect();
        loadFriends();
        renderMessages();

        // åŠ è½½å¥½å‹åˆ—è¡¨
        function loadFriends() {
            const users = JSON.parse(localStorage.getItem('gameUsers') || '{}');
            const currentUserData = users[currentUser];
            
            if (currentUserData && currentUserData.friends) {
                currentUserData.friends.forEach(friendUsername => {
                    const chatId = 'friend_' + friendUsername;
                    
                    if (!chats[chatId]) {
                        chats[chatId] = {
                            name: 'ğŸ’¬ ' + friendUsername,
                            messages: []
                        };
                    }
                    
                    const chatList = document.getElementById('chatList');
                    const friendAvatar = users[friendUsername].avatar;
                    const avatarHtml = friendAvatar 
                        ? `<img src="${friendAvatar}" alt="${friendUsername}">` 
                        : 'ğŸ‘¤';
                    
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    item.innerHTML = `
                        <div class="chat-item-avatar">${avatarHtml}</div>
                        <div class="chat-item-info">
                            <div class="chat-item-name">${friendUsername}</div>
                            <div class="chat-item-preview">å¥½å‹ - å¯ä»¥åˆ†äº«æ¸¸æˆ</div>
                        </div>
                    `;
                    item.onclick = function() { selectChat(chatId); };
                    chatList.appendChild(item);
                });
            }
        }
    </script>
</body>
</html>